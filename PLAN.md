# ë¼ë„¤ì¦ˆ ë­í‚¹ ì´ë²¤íŠ¸ ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ì‹œìŠ¤í…œ

## í”„ë¡œì íŠ¸ ê°œìš”

ì•„ë§ˆì¡´ ë­í‚¹ ë³€ë™ì„ ëª¨ë‹ˆí„°ë§í•˜ê³ , **ì´ë²¤íŠ¸ ë°œìƒ ì‹œì ì—ë§Œ** ì›ì¸ ë¶„ì„ìš© ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ LLM ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ëŠ” ì‹œìŠ¤í…œ.

### í•µì‹¬ ì»¨ì…‰: Event-Driven Intelligence

**ê¸°ì¡´ ë°©ì‹ì˜ ë¬¸ì œì :**
- ë°ì´í„°ë¥¼ ë¬´ì¡°ê±´ ë§ì´ ëª¨ìœ¼ëŠ” ë°©ì‹ (ë¹„íš¨ìœ¨ì )
- ML ëª¨ë¸ í•™ìŠµì— í•„ìš”í•œ ì¶©ë¶„í•œ ë°ì´í„° í™•ë³´ ì–´ë ¤ì›€
- ì‹¤ì§ˆì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜ ì œê³µ ë¶€ì¡±

**ìƒˆë¡œìš´ ì ‘ê·¼:**
```
â‘  ë­í‚¹ ë°ì´í„° ì£¼ê¸°ì  ìˆ˜ì§‘ (6ì‹œê°„ë§ˆë‹¤)
    â†“
â‘¡ ë­í‚¹ ë³€ë™ ì´ë²¤íŠ¸ ê°ì§€ (ìˆœìœ„ ê¸‰ë“±/ê¸‰ë½)
    â†“
â‘¢ ì´ë²¤íŠ¸ ì‹œì  ê¸°ì¤€ ì›ì¸ ë°ì´í„° ì§‘ì¤‘ ìˆ˜ì§‘
   - ì†Œì…œë¯¸ë””ì–´ (YouTube, TikTok, Instagram)
   - ë¦¬ë·° ë°ì´í„°
   - ê²½ìŸì‚¬ ë™í–¥
    â†“
â‘£ LLM ê¸°ë°˜ ì›ì¸ ë¶„ì„ ë° ì¸ì‚¬ì´íŠ¸ ë„ì¶œ
    â†“
â‘¤ ë¦¬í¬íŠ¸ ìƒì„± ë° ì•Œë¦¼
```

**í•µì‹¬ ê°€ì¹˜:**
- ğŸ’° **ë¹„ìš© íš¨ìœ¨**: ì´ë²¤íŠ¸ ë°œìƒ ì‹œì—ë§Œ ì§‘ì¤‘ ìˆ˜ì§‘
- ğŸ¯ **ì‹¤ìš©ì„±**: ë­í‚¹ ë³€ë™ ì›ì¸ì„ ëª…í™•íˆ íŒŒì•…
- ğŸ“Š **í™•ì¥ì„±**: ê²½ìŸì‚¬, ë¦¬ë·°, ë‰´ìŠ¤ ë“± ë°ì´í„° ì†ŒìŠ¤ ì¶”ê°€ ìš©ì´
- ğŸ¤– **ìë™í™”**: ì´ë²¤íŠ¸ ê°ì§€ë¶€í„° ì¸ì‚¬ì´íŠ¸ ìƒì„±ê¹Œì§€ ì™„ì „ ìë™

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Prefect Orchestration                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ Flow 1  â”‚          â”‚  Flow 2   â”‚        â”‚  Flow 3    â”‚
   â”‚ Ranking â”‚â”€â”€eventâ”€â”€â–¶â”‚  Context  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Insight   â”‚
   â”‚ Monitor â”‚          â”‚Collection â”‚        â”‚ Generation â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚              PostgreSQL Database                    â”‚
   â”‚  â€¢ amazon_rankings (ì‹œê³„ì—´)                         â”‚
   â”‚  â€¢ ranking_events (ì´ë²¤íŠ¸ ë©”íƒ€ë°ì´í„°)               â”‚
   â”‚  â€¢ event_context_social (ì›ì¸ ë°ì´í„°)               â”‚
   â”‚  â€¢ event_insights (LLM ë¶„ì„ ê²°ê³¼)                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ Prefect â”‚          â”‚   Slack   â”‚        â”‚   Excel    â”‚
   â”‚Artifactsâ”‚          â”‚   Notify  â”‚        â”‚   Export   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flow ìƒì„¸ ì„¤ê³„

#### Flow 1: Ranking Monitor (ì£¼ê¸°ì  ì‹¤í–‰)
**ì‹¤í–‰ ì£¼ê¸°**: 6ì‹œê°„ë§ˆë‹¤ (or ì‚¬ìš©ì ì„¤ì • ê°€ëŠ¥)

```python
@flow(name="ranking_monitor")
def ranking_monitor_flow():
    # 1. Amazon ë­í‚¹ ìˆ˜ì§‘
    rankings = scrape_amazon_rankings()

    # 2. DB ì €ì¥
    save_rankings(rankings)

    # 3. ì´ë²¤íŠ¸ ê°ì§€
    events = detect_ranking_events()

    # 4. ì´ë²¤íŠ¸ ë°œê²¬ ì‹œ Flow 2 íŠ¸ë¦¬ê±°
    for event in events:
        context_collection_flow.submit(event_id=event.id)
```

**ì´ë²¤íŠ¸ ê°ì§€ ê¸°ì¤€:**
- ìˆœìœ„ ê¸‰ë“±: 10ìœ„ ì´ìƒ ìƒìŠ¹ or 30% ì´ìƒ ìƒìŠ¹
- ìˆœìœ„ ê¸‰ë½: 10ìœ„ ì´ìƒ í•˜ë½ or 30% ì´ìƒ í•˜ë½
- ê°€ê²© ë³€ë™: 20% ì´ìƒ ë³€ë™
- ë¦¬ë·° ê¸‰ì¦: 100ê°œ ì´ìƒ ì¦ê°€
- í’ˆì ˆ ìƒíƒœ ë³€í™”

#### Flow 2: Context Collection (ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°)
**ì‹¤í–‰ ì¡°ê±´**: ì´ë²¤íŠ¸ ê°ì§€ ì‹œ ìë™ ì‹¤í–‰

```python
@flow(name="context_collection")
def context_collection_flow(event_id: int):
    # 1. ì´ë²¤íŠ¸ ì •ë³´ ë¡œë“œ
    event = get_event_info(event_id)

    # 2. ì‹œê°„ ë²”ìœ„ ê³„ì‚°
    time_window = calculate_time_window(event)
    # ì˜ˆ: ì´ë²¤íŠ¸ ì „ 7ì¼ ~ í›„ 3ì¼

    # 3. ì›ì¸ ë°ì´í„° ìˆ˜ì§‘ (ë³‘ë ¬)
    social_data = collect_social_media(
        product=event.product,
        start_date=time_window.start,
        end_date=time_window.end
    )

    reviews = collect_reviews(
        asin=event.product.asin,
        time_window=time_window
    )

    competitors = collect_competitor_data(
        category=event.category,
        time_window=time_window
    )

    # 4. ë°ì´í„° ì €ì¥ (ì´ë²¤íŠ¸ì™€ ì—°ê²°)
    save_event_context(event_id, social_data, reviews, competitors)

    # 5. Flow 3 íŠ¸ë¦¬ê±°
    insight_generation_flow.submit(event_id=event_id)
```

#### Flow 3: Insight Generation (LLM ë¶„ì„)
**ì‹¤í–‰ ì¡°ê±´**: ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ í›„

```python
@flow(name="insight_generation")
def insight_generation_flow(event_id: int):
    # 1. ì´ë²¤íŠ¸ ë° ìˆ˜ì§‘ ë°ì´í„° ë¡œë“œ
    context = load_event_context(event_id)

    # 2. LLM í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    prompt = build_insight_prompt(context)

    # 3. LLM ë¶„ì„ (Claude/GPT-4)
    insight = generate_llm_insight(prompt)
    # ì¶œë ¥:
    # - ë³€ë™ ì›ì¸ 3ê°€ì§€ (ìš°ì„ ìˆœìœ„)
    # - ë°ì´í„° ê¸°ë°˜ ê·¼ê±°
    # - ê¶Œì¥ ì•¡ì…˜
    # - ì‹ ë¢°ë„ ì ìˆ˜

    # 4. ì¸ì‚¬ì´íŠ¸ ì €ì¥
    save_insight(event_id, insight)

    # 5. ë¦¬í¬íŠ¸ ìƒì„±
    create_event_report_artifact(event_id)

    # 6. ì•Œë¦¼ (ì„ íƒ)
    if insight.severity == 'critical':
        send_slack_notification(insight)
```

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 1. ê¸°ì¡´ í…Œì´ë¸” (ìœ ì§€)

```sql
-- ë¸Œëœë“œ ê´€ë¦¬
brands (
    id, name, brand_type ['target'|'competitor'],
    keywords[], is_active, created_at
)

-- ì•„ë§ˆì¡´ ì¹´í…Œê³ ë¦¬
amazon_categories (
    id, category_name, category_url, parent_category_id
)

-- ì•„ë§ˆì¡´ ì œí’ˆ
amazon_products (
    id, asin, product_name, brand_id, product_url,
    first_seen_at, last_seen_at, is_active
)

-- ì•„ë§ˆì¡´ ë­í‚¹ (ì‹œê³„ì—´ ë°ì´í„°)
amazon_rankings (
    id, product_id, category_id, rank, price, rating,
    review_count, is_prime, stock_status, collected_at,
    INDEX: (product_id, category_id, collected_at DESC)
)
```

### 2. ìƒˆë¡œìš´ í…Œì´ë¸” (ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ)

```sql
-- ë­í‚¹ ì´ë²¤íŠ¸ (ë³€ë™ ê°ì§€)
ranking_events (
    id SERIAL PRIMARY KEY,
    product_id INT REFERENCES amazon_products(id),
    category_id INT REFERENCES amazon_categories(id),

    -- ì´ë²¤íŠ¸ íƒ€ì…
    event_type VARCHAR(50),  -- 'RANK_SURGE', 'RANK_DROP', 'PRICE_CHANGE', etc.
    severity VARCHAR(20),    -- 'critical', 'high', 'medium', 'low'

    -- ë­í‚¹ ë³€ë™
    prev_rank INT,
    curr_rank INT,
    rank_change INT,         -- curr - prev (ìŒìˆ˜ë©´ ìƒìŠ¹)
    rank_change_pct FLOAT,   -- ë³€ë™ ë¹„ìœ¨

    -- ê°€ê²© ë³€ë™
    prev_price DECIMAL(10,2),
    curr_price DECIMAL(10,2),
    price_change_pct FLOAT,

    -- ë¦¬ë·° ë³€ë™
    prev_review_count INT,
    curr_review_count INT,
    review_change INT,

    -- ì‹œê°„ ì •ë³´
    detected_at TIMESTAMP,
    time_window_start TIMESTAMP,  -- ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
    time_window_end TIMESTAMP,    -- ë°ì´í„° ìˆ˜ì§‘ ì¢…ë£Œ

    -- ì²˜ë¦¬ ìƒíƒœ
    context_collected BOOLEAN DEFAULT FALSE,
    insight_generated BOOLEAN DEFAULT FALSE,

    created_at TIMESTAMP DEFAULT NOW(),

    INDEX: (detected_at DESC),
    INDEX: (product_id, detected_at DESC),
    INDEX: (event_type, severity)
)

-- ì´ë²¤íŠ¸ ì›ì¸ ë°ì´í„°: ì†Œì…œë¯¸ë””ì–´
event_context_social (
    id SERIAL PRIMARY KEY,
    event_id INT REFERENCES ranking_events(id) ON DELETE CASCADE,

    platform VARCHAR(20),     -- 'youtube', 'tiktok', 'instagram'
    content_id VARCHAR(255),
    author VARCHAR(255),
    text TEXT,
    hashtags TEXT[],

    -- ë©”íŠ¸ë¦­
    view_count BIGINT,
    like_count BIGINT,
    comment_count INT,
    share_count INT,
    engagement_score INT,     -- í†µí•© engagement ì ìˆ˜

    posted_at TIMESTAMP,
    collected_at TIMESTAMP DEFAULT NOW(),

    -- ë°”ì´ëŸ´ ì—¬ë¶€
    is_viral BOOLEAN,         -- engagement ì„ê³„ê°’ ê¸°ì¤€

    INDEX: (event_id, engagement_score DESC)
)

-- ì´ë²¤íŠ¸ ì›ì¸ ë°ì´í„°: ë¦¬ë·°
event_context_reviews (
    id SERIAL PRIMARY KEY,
    event_id INT REFERENCES ranking_events(id) ON DELETE CASCADE,

    review_id VARCHAR(255),
    reviewer_name VARCHAR(255),
    rating INT,
    verified_purchase BOOLEAN,
    review_title TEXT,
    review_text TEXT,
    helpful_count INT,
    review_date TIMESTAMP,
    collected_at TIMESTAMP DEFAULT NOW(),

    -- ê°ì„± ë¶„ì„ (ì„ íƒ)
    sentiment VARCHAR(20),    -- 'positive', 'negative', 'neutral'
    sentiment_score FLOAT,

    INDEX: (event_id, review_date DESC)
)

-- ì´ë²¤íŠ¸ ì›ì¸ ë°ì´í„°: ê²½ìŸì‚¬
event_context_competitors (
    id SERIAL PRIMARY KEY,
    event_id INT REFERENCES ranking_events(id) ON DELETE CASCADE,

    competitor_product_id INT REFERENCES amazon_products(id),
    competitor_rank INT,
    competitor_price DECIMAL(10,2),
    competitor_rating FLOAT,
    rank_change INT,
    price_change_pct FLOAT,

    collected_at TIMESTAMP DEFAULT NOW(),

    INDEX: (event_id)
)

-- LLM ì¸ì‚¬ì´íŠ¸ ê²°ê³¼
event_insights (
    id SERIAL PRIMARY KEY,
    event_id INT REFERENCES ranking_events(id) ON DELETE CASCADE,

    -- ì¸ì‚¬ì´íŠ¸ ë‚´ìš©
    insight_type VARCHAR(50),     -- 'ranking_change', 'viral_correlation', etc.
    summary TEXT,                 -- ìš”ì•½ (2-3ë¬¸ì¥)

    -- ì›ì¸ ë¶„ì„ (JSON)
    causes JSONB,                 -- [{cause: "...", evidence: "...", confidence: 0.85}]

    -- ë°ì´í„° ê·¼ê±°
    evidence JSONB,               -- {social: [...], reviews: [...], competitors: [...]}

    -- ê¶Œì¥ ì•¡ì…˜
    recommendations JSONB,        -- [{action: "...", priority: "high", expected_impact: "..."}]

    -- ì‹ ë¢°ë„
    confidence_score FLOAT,       -- 0-1

    -- ë©”íƒ€ë°ì´í„°
    llm_model VARCHAR(50),        -- 'claude-3-5-sonnet', 'gpt-4', etc.
    prompt_tokens INT,
    completion_tokens INT,

    generated_at TIMESTAMP DEFAULT NOW(),

    INDEX: (event_id),
    INDEX: (generated_at DESC)
)
```

---

## ì´ë²¤íŠ¸ ê°ì§€ ë¡œì§ ìƒì„¸

### Event Detection Algorithm

```python
def detect_ranking_events(
    product_id: int,
    category_id: int,
    lookback_hours: int = 12
) -> List[RankingEvent]:
    """
    ë­í‚¹ ë³€ë™ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.

    ê°ì§€ ê¸°ì¤€:
    1. ìˆœìœ„ ê¸‰ë“±: 10ìœ„ ì´ìƒ ìƒìŠ¹ or 30% ì´ìƒ ìƒìŠ¹
    2. ìˆœìœ„ ê¸‰ë½: 10ìœ„ ì´ìƒ í•˜ë½ or 30% ì´ìƒ í•˜ë½
    3. ê°€ê²© ë³€ë™: 20% ì´ìƒ ë³€ë™
    4. ë¦¬ë·° ê¸‰ì¦: 100ê°œ ì´ìƒ ì¦ê°€ (in 12h)
    5. í’ˆì ˆ ìƒíƒœ ë³€í™”: in_stock â†” out_of_stock
    """

    # ìµœê·¼ 2ê°œ ë°ì´í„° í¬ì¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
    current = get_latest_ranking(product_id, category_id)
    previous = get_previous_ranking(product_id, category_id, hours_ago=lookback_hours)

    events = []

    # 1. ìˆœìœ„ ë³€ë™ ì²´í¬
    if previous and current:
        rank_change = current.rank - previous.rank
        rank_change_pct = abs(rank_change) / previous.rank * 100

        if rank_change <= -10 or rank_change_pct >= 30:  # ìƒìŠ¹ (ìˆ«ì ê°ì†Œ)
            events.append(RankingEvent(
                event_type='RANK_SURGE',
                severity=calculate_severity(rank_change_pct),
                rank_change=rank_change,
                rank_change_pct=rank_change_pct
            ))

        elif rank_change >= 10 or rank_change_pct >= 30:  # í•˜ë½
            events.append(RankingEvent(
                event_type='RANK_DROP',
                severity=calculate_severity(rank_change_pct),
                rank_change=rank_change,
                rank_change_pct=rank_change_pct
            ))

        # 2. ê°€ê²© ë³€ë™ ì²´í¬
        if previous.price and current.price:
            price_change_pct = abs(
                (current.price - previous.price) / previous.price * 100
            )

            if price_change_pct >= 20:
                events.append(RankingEvent(
                    event_type='PRICE_CHANGE',
                    severity='high' if price_change_pct >= 40 else 'medium',
                    price_change_pct=price_change_pct
                ))

        # 3. ë¦¬ë·° ê¸‰ì¦ ì²´í¬
        review_change = current.review_count - previous.review_count
        if review_change >= 100:
            events.append(RankingEvent(
                event_type='REVIEW_SURGE',
                severity='high',
                review_change=review_change
            ))

        # 4. í’ˆì ˆ ìƒíƒœ ë³€í™”
        if previous.stock_status != current.stock_status:
            events.append(RankingEvent(
                event_type='STOCK_CHANGE',
                severity='critical' if current.stock_status == 'out_of_stock' else 'medium'
            ))

    return events


def calculate_severity(change_pct: float) -> str:
    """ë³€ë™ í­ì— ë”°ë¼ ì‹¬ê°ë„ ê³„ì‚°"""
    if change_pct >= 70:
        return 'critical'
    elif change_pct >= 50:
        return 'high'
    elif change_pct >= 30:
        return 'medium'
    else:
        return 'low'


def calculate_time_window(event: RankingEvent) -> TimeWindow:
    """
    ì´ë²¤íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘ ì‹œê°„ ë²”ìœ„ ê³„ì‚°

    ì „ëµ:
    - ì´ë²¤íŠ¸ ë°œìƒ ì „ 7ì¼: íŠ¸ë Œë“œ íŒŒì•…
    - ì´ë²¤íŠ¸ ë°œìƒ í›„ 3ì¼: ì˜í–¥ í™•ì¸
    """
    return TimeWindow(
        start=event.detected_at - timedelta(days=7),
        end=event.detected_at + timedelta(days=3)
    )
```

---

## LLM Insight Generation

### Prompt Engineering

```python
INSIGHT_PROMPT_TEMPLATE = """
ë‹¹ì‹ ì€ ì „ììƒê±°ë˜ ë­í‚¹ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

## ì´ë²¤íŠ¸ ì •ë³´
- ì œí’ˆ: {product_name} (ASIN: {asin})
- ì¹´í…Œê³ ë¦¬: {category_name}
- ì´ë²¤íŠ¸ íƒ€ì…: {event_type}
- ë­í‚¹ ë³€ë™: {prev_rank} â†’ {curr_rank} ({rank_change:+d})
- ê°€ê²© ë³€ë™: ${prev_price} â†’ ${curr_price} ({price_change_pct:+.1f}%)
- ë¦¬ë·° ë³€ë™: {prev_reviews} â†’ {curr_reviews} (+{review_change})
- ê°ì§€ ì‹œì : {detected_at}

## ìˆ˜ì§‘ëœ ì›ì¸ ë°ì´í„°

### ì†Œì…œë¯¸ë””ì–´ í™œë™ (ì´ë²¤íŠ¸ ì „í›„ 7ì¼)
{social_media_summary}

Top 5 ë°”ì´ëŸ´ ì½˜í…ì¸ :
{top_viral_content}

### ë¦¬ë·° ë¶„ì„
- ì‹ ê·œ ë¦¬ë·° ìˆ˜: {new_reviews_count}
- í‰ê·  í‰ì : {avg_rating}
- ê°ì„± ë¶„í¬: ê¸ì • {positive_pct}%, ë¶€ì • {negative_pct}%

ì£¼ìš” ë¦¬ë·° í‚¤ì›Œë“œ:
{review_keywords}

### ê²½ìŸì‚¬ ë™í–¥
{competitor_changes}

## ë¶„ì„ ìš”ì²­

ë‹¤ìŒ í˜•ì‹ì˜ JSONìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:

{{
  "summary": "2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½",
  "causes": [
    {{
      "cause": "ì›ì¸ ì„¤ëª…",
      "evidence": "ë°ì´í„° ê¸°ë°˜ ê·¼ê±°",
      "confidence": 0.0-1.0
    }}
  ],
  "recommendations": [
    {{
      "action": "ê¶Œì¥ ì•¡ì…˜",
      "priority": "high|medium|low",
      "expected_impact": "ì˜ˆìƒ íš¨ê³¼"
    }}
  ],
  "confidence_score": 0.0-1.0
}}

**ì¤‘ìš”**:
1. ì›ì¸ì€ ìˆ˜ì§‘ëœ ë°ì´í„°ì— ê¸°ë°˜í•´ì•¼ í•¨ (ì¶”ì¸¡ ê¸ˆì§€)
2. ìƒìœ„ 3ê°œ ì›ì¸ë§Œ ì œì‹œ (ìš°ì„ ìˆœìœ„ ìˆœ)
3. ì‹ ë¢°ë„ ì ìˆ˜ëŠ” ë°ì´í„° í’ˆì§ˆê³¼ ìƒê´€ê´€ê³„ ê°•ë„ ê³ ë ¤
"""


def generate_llm_insight(event_id: int) -> EventInsight:
    """LLMì„ ì‚¬ìš©í•´ ì´ë²¤íŠ¸ ì¸ì‚¬ì´íŠ¸ ìƒì„±"""

    # 1. ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ
    context = load_event_context(event_id)

    # 2. ì†Œì…œë¯¸ë””ì–´ ìš”ì•½ ìƒì„±
    social_summary = summarize_social_media(context.social_data)
    top_viral = format_top_viral_content(context.social_data, limit=5)

    # 3. ë¦¬ë·° ë¶„ì„
    review_analysis = analyze_reviews(context.reviews)

    # 4. ê²½ìŸì‚¬ ë³€ë™ ìš”ì•½
    competitor_summary = summarize_competitor_changes(context.competitors)

    # 5. í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    prompt = INSIGHT_PROMPT_TEMPLATE.format(
        product_name=context.event.product.name,
        asin=context.event.product.asin,
        category_name=context.event.category.name,
        event_type=context.event.event_type,
        prev_rank=context.event.prev_rank,
        curr_rank=context.event.curr_rank,
        rank_change=context.event.rank_change,
        prev_price=context.event.prev_price,
        curr_price=context.event.curr_price,
        price_change_pct=context.event.price_change_pct,
        prev_reviews=context.event.prev_review_count,
        curr_reviews=context.event.curr_review_count,
        review_change=context.event.review_change,
        detected_at=context.event.detected_at.strftime('%Y-%m-%d %H:%M'),
        social_media_summary=social_summary,
        top_viral_content=top_viral,
        new_reviews_count=review_analysis.new_count,
        avg_rating=review_analysis.avg_rating,
        positive_pct=review_analysis.positive_pct,
        negative_pct=review_analysis.negative_pct,
        review_keywords=review_analysis.top_keywords,
        competitor_changes=competitor_summary
    )

    # 6. LLM í˜¸ì¶œ
    response = call_llm(
        prompt=prompt,
        model="claude-3-5-sonnet-20241022",
        temperature=0.3,
        max_tokens=2000
    )

    # 7. JSON íŒŒì‹± ë° ê²€ì¦
    insight_data = parse_and_validate_insight(response)

    # 8. ì¸ì‚¬ì´íŠ¸ ê°ì²´ ìƒì„±
    insight = EventInsight(
        event_id=event_id,
        insight_type='ranking_change',
        summary=insight_data['summary'],
        causes=insight_data['causes'],
        recommendations=insight_data['recommendations'],
        confidence_score=insight_data['confidence_score'],
        llm_model="claude-3-5-sonnet",
        prompt_tokens=response.usage.input_tokens,
        completion_tokens=response.usage.output_tokens
    )

    return insight
```

---

## êµ¬í˜„ ë‹¨ê³„

### Phase 1: ì´ë²¤íŠ¸ ê°ì§€ ì‹œìŠ¤í…œ (1ì£¼)

**ëª©í‘œ**: ë­í‚¹ ëª¨ë‹ˆí„°ë§ ë° ì´ë²¤íŠ¸ ê°ì§€ ìë™í™”

1. **DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸**
   - `ranking_events` í…Œì´ë¸” ì¶”ê°€
   - Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
   ```bash
   alembic revision --autogenerate -m "Add ranking events table"
   alembic upgrade head
   ```

2. **ì´ë²¤íŠ¸ ê°ì§€ ë¡œì§ êµ¬í˜„**
   - `src/analyzers/event_detector.py` ìƒì„±
   - `detect_ranking_events()` í•¨ìˆ˜ êµ¬í˜„
   - ê°ì§€ ê¸°ì¤€ ì„¤ì • (config/settings.py)

3. **Ranking Monitor Flow êµ¬í˜„**
   - `src/flows/ranking_monitor_flow.py` ìƒì„±
   - Amazon ë­í‚¹ ìˆ˜ì§‘ + ì´ë²¤íŠ¸ ê°ì§€
   - Prefect ìŠ¤ì¼€ì¤„ ì„¤ì • (6ì‹œê°„ë§ˆë‹¤)

4. **í…ŒìŠ¤íŠ¸**
   - ìˆ˜ë™ìœ¼ë¡œ ë­í‚¹ ë°ì´í„° ë³€ê²½í•´ì„œ ì´ë²¤íŠ¸ ê°ì§€ í™•ì¸
   - ì´ë²¤íŠ¸ íƒ€ì…ë³„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±

**ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] ë­í‚¹ ê¸‰ë“±/ê¸‰ë½ ì´ë²¤íŠ¸ ìë™ ê°ì§€
- [ ] ì´ë²¤íŠ¸ ë©”íƒ€ë°ì´í„° DB ì €ì¥
- [ ] ì‹¬ê°ë„(severity) ì •í™•íˆ ë¶„ë¥˜
- [ ] Prefect UIì—ì„œ ê°ì§€ëœ ì´ë²¤íŠ¸ í™•ì¸

---

### Phase 2: ì›ì¸ ë°ì´í„° ìˆ˜ì§‘ (1-2ì£¼)

**ëª©í‘œ**: ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì›ì¸ ë¶„ì„ìš© ë°ì´í„° ìë™ ìˆ˜ì§‘

1. **DB ìŠ¤í‚¤ë§ˆ ì¶”ê°€**
   - `event_context_social` í…Œì´ë¸”
   - `event_context_reviews` í…Œì´ë¸”
   - `event_context_competitors` í…Œì´ë¸”

2. **ì‹œê°„ ë²”ìœ„ ê¸°ë°˜ ì†Œì…œë¯¸ë””ì–´ ìˆ˜ì§‘ ìˆ˜ì •**
   - ê¸°ì¡´ `social_flow.py` ìˆ˜ì •
   - íŒŒë¼ë¯¸í„° ì¶”ê°€: `start_date`, `end_date`
   - ì˜ˆ: ì´ë²¤íŠ¸ ì „ 7ì¼ ~ í›„ 3ì¼ ë°ì´í„°ë§Œ ìˆ˜ì§‘

3. **ë¦¬ë·° ìˆ˜ì§‘ êµ¬í˜„** (ìƒˆë¡œìš´ ê¸°ëŠ¥)
   - `src/scrapers/amazon/review_scraper.py` ìƒì„±
   - Apify Amazon Review Scraper ì‚¬ìš©
   - íŠ¹ì • ê¸°ê°„ ë¦¬ë·°ë§Œ ìˆ˜ì§‘

4. **ê²½ìŸì‚¬ ë°ì´í„° ìˆ˜ì§‘**
   - ê°™ì€ ì¹´í…Œê³ ë¦¬ì˜ ê²½ìŸ ì œí’ˆ ë­í‚¹ ìˆ˜ì§‘
   - ë³€ë™ ë¹„êµ ë¶„ì„

5. **Context Collection Flow êµ¬í˜„**
   - `src/flows/context_collection_flow.py` ìƒì„±
   - ì´ë²¤íŠ¸ ID ë°›ì•„ì„œ ë³‘ë ¬ ë°ì´í„° ìˆ˜ì§‘
   - ëª¨ë“  ë°ì´í„°ë¥¼ `event_id`ì™€ ì—°ê²°í•´ì„œ ì €ì¥

**ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] ì´ë²¤íŠ¸ ê°ì§€ ì‹œ ìë™ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
- [ ] ì§€ì •ëœ ì‹œê°„ ë²”ìœ„ ë‚´ ë°ì´í„°ë§Œ ìˆ˜ì§‘
- [ ] ì†Œì…œë¯¸ë””ì–´, ë¦¬ë·°, ê²½ìŸì‚¬ ë°ì´í„° ëª¨ë‘ ì—°ê²°
- [ ] `event_context_*` í…Œì´ë¸”ì— ë°ì´í„° ì €ì¥

---

### Phase 3: LLM ì¸ì‚¬ì´íŠ¸ ìƒì„± (1ì£¼)

**ëª©í‘œ**: ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ LLMìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ ë„ì¶œ

1. **DB ìŠ¤í‚¤ë§ˆ ì¶”ê°€**
   - `event_insights` í…Œì´ë¸”

2. **LLM í´ë¼ì´ì–¸íŠ¸ ì„¤ì •**
   - `src/insights/llm_client.py` ì—…ë°ì´íŠ¸
   - Claude API ë˜ëŠ” OpenAI API ì„ íƒ

3. **í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§**
   - `src/insights/prompts.py` ìƒì„±
   - ë­í‚¹ ë³€ë™ ë¶„ì„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
   - JSON ì¶œë ¥ í˜•ì‹ ì •ì˜

4. **ì¸ì‚¬ì´íŠ¸ ìƒì„± ë¡œì§**
   - `src/insights/event_insight_generator.py` ìƒì„±
   - ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ìš”ì•½
   - LLM í˜¸ì¶œ ë° ì‘ë‹µ íŒŒì‹±
   - ì‹ ë¢°ë„ ì ìˆ˜ ê³„ì‚°

5. **Insight Generation Flow êµ¬í˜„**
   - `src/flows/insight_generation_flow.py` ìƒì„±
   - ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ í›„ ìë™ ì‹¤í–‰
   - ì¸ì‚¬ì´íŠ¸ DB ì €ì¥

6. **Prefect Artifacts ìƒì„±**
   - ì´ë²¤íŠ¸ ë¦¬í¬íŠ¸ (Markdown)
   - ì›ì¸ ë¶„ì„ ì°¨íŠ¸ (Table)
   - ê¶Œì¥ ì•¡ì…˜ (Markdown)

**ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] LLMì´ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì›ì¸ ë¶„ì„
- [ ] JSON í˜•ì‹ìœ¼ë¡œ êµ¬ì¡°í™”ëœ ì¸ì‚¬ì´íŠ¸ ìƒì„±
- [ ] ì‹ ë¢°ë„ ì ìˆ˜ í•©ë¦¬ì ìœ¼ë¡œ ê³„ì‚°
- [ ] Prefect UIì—ì„œ ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸ í™•ì¸
- [ ] 3ê°œ ìƒ˜í”Œ ì´ë²¤íŠ¸ ì¸ì‚¬ì´íŠ¸ í’ˆì§ˆ í‰ê°€

---

### Phase 4: ë¦¬í¬íŠ¸ & ì•Œë¦¼ (1ì£¼)

**ëª©í‘œ**: ì¸ì‚¬ì´íŠ¸ë¥¼ ì‹œê°í™”í•˜ê³  ì¤‘ìš” ì´ë²¤íŠ¸ ì•Œë¦¼

1. **Prefect Artifacts ê³ ë„í™”**
   - ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ ì°¨íŠ¸
   - ì†Œì…œë¯¸ë””ì–´ engagement ì¶”ì´ ê·¸ë˜í”„
   - ê²½ìŸì‚¬ ë¹„êµ í…Œì´ë¸”

2. **Excel ë¦¬í¬íŠ¸ ìƒì„±**
   - `src/reports/event_report_generator.py` ìƒì„±
   - ì´ë²¤íŠ¸ ìš”ì•½ ì‹œíŠ¸
   - ì›ì¸ ë°ì´í„° ì‹œíŠ¸
   - ì¸ì‚¬ì´íŠ¸ ì‹œíŠ¸

3. **Slack ì•Œë¦¼ ì—°ë™** (ì„ íƒ)
   - `src/services/notification_service.py` ìƒì„±
   - Critical/High ì´ë²¤íŠ¸ë§Œ ì•Œë¦¼
   - ì¸ì‚¬ì´íŠ¸ ìš”ì•½ í¬í•¨

4. **ëŒ€ì‹œë³´ë“œ ì¡°íšŒ API** (ì„ íƒ)
   - FastAPI ê°„ë‹¨í•œ ì—”ë“œí¬ì¸íŠ¸
   - ìµœê·¼ ì´ë²¤íŠ¸ ëª©ë¡
   - ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´

**ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] Prefect UIì—ì„œ ì‹œê°í™”ëœ ë¦¬í¬íŠ¸ í™•ì¸
- [ ] Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° ë‚´ìš© í™•ì¸
- [ ] Slack ì•Œë¦¼ ì •ìƒ ì‘ë™ (ì„ íƒ)
- [ ] íˆìŠ¤í† ë¦¬ ì¡°íšŒ ê°€ëŠ¥

---

### Phase 5: í™•ì¥ (ì„ íƒ, 1-2ì£¼)

**ëª©í‘œ**: ë°ì´í„° ì†ŒìŠ¤ í™•ì¥ ë° ê³ ë„í™”

1. **ê²½ìŸì‚¬ ì¶”ê°€**
   - ì—¬ëŸ¬ ë¸Œëœë“œ ë™ì‹œ ëª¨ë‹ˆí„°ë§
   - ë¸Œëœë“œë³„ ì´ë²¤íŠ¸ ë¹„êµ

2. **ë‰´ìŠ¤/PR ë°ì´í„° ìˆ˜ì§‘**
   - Google News API
   - ë¸Œëœë“œ ì–¸ê¸‰ ê¸°ì‚¬ ìˆ˜ì§‘
   - ì´ë²¤íŠ¸ì™€ ì—°ê²°

3. **ê°ì„± ë¶„ì„**
   - ë¦¬ë·° ê°ì„± ë¶„ì„ (ê¸ì •/ë¶€ì •)
   - ì†Œì…œë¯¸ë””ì–´ ëŒ“ê¸€ ê°ì„± ë¶„ì„

4. **ì˜ˆì¸¡ ëª¨ë¸**
   - ê³¼ê±° ì´ë²¤íŠ¸ í•™ìŠµ
   - ë­í‚¹ ë³€ë™ ì˜ˆì¸¡

---

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
laneige-ranking-tracker/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py              # ì¤‘ì•™ ì„¤ì •
â”‚   â”œâ”€â”€ event_thresholds.py      # ì´ë²¤íŠ¸ ê°ì§€ ì„ê³„ê°’
â”‚   â””â”€â”€ categories.json
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ database.py
â”‚   â”‚   â””â”€â”€ logging.py
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ amazon.py            # ê¸°ì¡´ ëª¨ë¸
â”‚   â”‚   â”œâ”€â”€ events.py            # â­ ì´ë²¤íŠ¸ ê´€ë ¨ ëª¨ë¸ (ì‹ ê·œ)
â”‚   â”‚   â”œâ”€â”€ social_media.py
â”‚   â”‚   â””â”€â”€ brands.py
â”‚   â”‚
â”‚   â”œâ”€â”€ scrapers/
â”‚   â”‚   â”œâ”€â”€ amazon/
â”‚   â”‚   â”‚   â”œâ”€â”€ ranking_scraper.py
â”‚   â”‚   â”‚   â””â”€â”€ review_scraper.py  # â­ ë¦¬ë·° ìˆ˜ì§‘ (ì‹ ê·œ)
â”‚   â”‚   â””â”€â”€ social/
â”‚   â”‚       â”œâ”€â”€ youtube_apify.py
â”‚   â”‚       â”œâ”€â”€ tiktok_apify.py
â”‚   â”‚       â””â”€â”€ instagram_apify.py
â”‚   â”‚
â”‚   â”œâ”€â”€ analyzers/
â”‚   â”‚   â”œâ”€â”€ event_detector.py    # â­ ì´ë²¤íŠ¸ ê°ì§€ (í•µì‹¬)
â”‚   â”‚   â””â”€â”€ data_summarizer.py   # ìˆ˜ì§‘ ë°ì´í„° ìš”ì•½
â”‚   â”‚
â”‚   â”œâ”€â”€ insights/
â”‚   â”‚   â”œâ”€â”€ event_insight_generator.py  # â­ LLM ì¸ì‚¬ì´íŠ¸ (í•µì‹¬)
â”‚   â”‚   â”œâ”€â”€ prompts.py           # í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
â”‚   â”‚   â””â”€â”€ llm_client.py
â”‚   â”‚
â”‚   â”œâ”€â”€ flows/
â”‚   â”‚   â”œâ”€â”€ ranking_monitor_flow.py     # â­ Flow 1 (í•µì‹¬)
â”‚   â”‚   â”œâ”€â”€ context_collection_flow.py  # â­ Flow 2 (í•µì‹¬)
â”‚   â”‚   â”œâ”€â”€ insight_generation_flow.py  # â­ Flow 3 (í•µì‹¬)
â”‚   â”‚   â””â”€â”€ social_flow.py       # ê¸°ì¡´ (ìˆ˜ì •)
â”‚   â”‚
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”œâ”€â”€ amazon_tasks.py
â”‚   â”‚   â”œâ”€â”€ social_tasks.py
â”‚   â”‚   â””â”€â”€ event_tasks.py       # â­ ì´ë²¤íŠ¸ ê´€ë ¨ íƒœìŠ¤í¬
â”‚   â”‚
â”‚   â”œâ”€â”€ reports/
â”‚   â”‚   â”œâ”€â”€ event_report_generator.py  # â­ ì´ë²¤íŠ¸ ë¦¬í¬íŠ¸
â”‚   â”‚   â””â”€â”€ artifact_creator.py
â”‚   â”‚
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ notification_service.py  # Slack ì•Œë¦¼
â”‚       â””â”€â”€ time_window_calculator.py
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ init_db.py
â”‚   â”œâ”€â”€ migrate_to_event_system.py  # ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
â”‚   â”œâ”€â”€ run_ranking_monitor.py      # â­ ë©”ì¸ ì‹¤í–‰ íŒŒì¼
â”‚   â”œâ”€â”€ test_event_detection.py     # ì´ë²¤íŠ¸ ê°ì§€ í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ export_ml_dataset.py        # ê¸°ì¡´ (ìœ ì§€)
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ reports/                # ì´ë²¤íŠ¸ ë¦¬í¬íŠ¸ Excel
â”‚   â””â”€â”€ datasets/               # ML ë°ì´í„°ì…‹
â”‚
â”œâ”€â”€ alembic/                    # DB ë§ˆì´ê·¸ë ˆì´ì…˜
â”‚   â””â”€â”€ versions/
â”‚
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env
â””â”€â”€ README.md
```

---

## ê¸°ìˆ  ìŠ¤íƒ

| êµ¬ë¶„ | ê¸°ìˆ  | ìš©ë„ |
|------|------|------|
| **Orchestration** | Prefect 3.x | Flow ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜, ìŠ¤ì¼€ì¤„ë§, Artifacts |
| **Database** | PostgreSQL + SQLAlchemy | ì‹œê³„ì—´ ë°ì´í„°, JSONB ì§€ì› |
| **Scraping** | Apify (ìš°ì„ ), Playwright (ë°±ì—…) | Amazon, ì†Œì…œë¯¸ë””ì–´, ë¦¬ë·° ìˆ˜ì§‘ |
| **LLM** | Claude 3.5 Sonnet (or GPT-4) | ì¸ì‚¬ì´íŠ¸ ìƒì„± |
| **YouTube** | YouTube Data API v3 | ê³µì‹ API |
| **TikTok** | Apify TikTok Scraper | ë¹„ê³µì‹ í¬ë¡¤ë§ |
| **Instagram** | Apify Instagram Scraper | í•´ì‹œíƒœê·¸ ê²€ìƒ‰ |
| **Logging** | Loguru | êµ¬ì¡°í™”ëœ ë¡œê¹… |
| **Export** | Pandas + openpyxl | Excel ë¦¬í¬íŠ¸ |

---

## í™˜ê²½ ë³€ìˆ˜ (.env)

```bash
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/laneige_tracker

# Apify
APIFY_API_KEY=apify_api_...

# YouTube
YOUTUBE_API_KEY=AIza...

# Claude API (or OpenAI)
ANTHROPIC_API_KEY=sk-ant-...
# OPENAI_API_KEY=sk-...

# Event Detection Thresholds
EVENT_RANK_CHANGE_THRESHOLD=10
EVENT_RANK_CHANGE_PCT_THRESHOLD=30.0
EVENT_PRICE_CHANGE_PCT_THRESHOLD=20.0
EVENT_REVIEW_SURGE_THRESHOLD=100

# Time Windows
EVENT_LOOKBACK_DAYS=7
EVENT_LOOKFORWARD_DAYS=3

# Prefect
PREFECT_API_URL=http://localhost:4200/api

# Notification (ì„ íƒ)
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...

# Logging
LOG_LEVEL=INFO
```

---

## ì‹¤í–‰ ë°©ë²•

### 1. ì´ˆê¸° ì„¤ì •

```bash
# ê°€ìƒí™˜ê²½
python -m venv venv
source venv/bin/activate

# ì˜ì¡´ì„± ì„¤ì¹˜
pip install -r requirements.txt

# í™˜ê²½ ë³€ìˆ˜
cp .env.example .env
# .env í¸ì§‘

# DB ë§ˆì´ê·¸ë ˆì´ì…˜
alembic upgrade head

# ì´ˆê¸° ë°ì´í„° ì‹œë”©
python scripts/init_db.py
```

### 2. Prefect ì„¤ì •

```bash
# Prefect ì„œë²„ ì‹œì‘
prefect server start

# Flow ë“±ë¡ ë° ë°°í¬
python scripts/run_ranking_monitor.py
```

### 3. ìˆ˜ë™ í…ŒìŠ¤íŠ¸

```bash
# ë­í‚¹ ìˆ˜ì§‘ + ì´ë²¤íŠ¸ ê°ì§€ í…ŒìŠ¤íŠ¸
python scripts/test_event_detection.py

# íŠ¹ì • ì´ë²¤íŠ¸ ì¸ì‚¬ì´íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸
python scripts/test_event_detection.py --event-id 1
```

### 4. í”„ë¡œë•ì…˜ ì‹¤í–‰

Prefect ìŠ¤ì¼€ì¤„ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰:
- **Ranking Monitor Flow**: 6ì‹œê°„ë§ˆë‹¤
- **Context Collection Flow**: ì´ë²¤íŠ¸ ê°ì§€ ì‹œ ìë™
- **Insight Generation Flow**: ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ ì‹œ ìë™

---

## ì„±ê³µ ì§€í‘œ

1. **ì´ë²¤íŠ¸ ê°ì§€ ì •í™•ë„**
   - ì‹¤ì œ ì¤‘ìš”í•œ ë­í‚¹ ë³€ë™ 90% ì´ìƒ ê°ì§€
   - False Positive < 10%

2. **ì¸ì‚¬ì´íŠ¸ í’ˆì§ˆ**
   - LLM ì¸ì‚¬ì´íŠ¸ê°€ ì‹¤ì œ ì›ì¸ ì„¤ëª… ê°€ëŠ¥
   - ë°ì´í„° ê¸°ë°˜ ê·¼ê±° ì œì‹œ
   - ì‹¤í–‰ ê°€ëŠ¥í•œ ê¶Œì¥ ì•¡ì…˜ ì œê³µ

3. **ì‹œìŠ¤í…œ ì•ˆì •ì„±**
   - Flow ì„±ê³µë¥  > 95%
   - ì´ë²¤íŠ¸ ê°ì§€ â†’ ì¸ì‚¬ì´íŠ¸ ìƒì„± E2E ì‹œê°„ < 30ë¶„

4. **ë¹„ì¦ˆë‹ˆìŠ¤ ê°€ì¹˜**
   - ë­í‚¹ ë³€ë™ ì›ì¸ íŒŒì•… ì‹œê°„ ë‹¨ì¶• (ìˆ˜ë™ ë¶„ì„ vs ìë™)
   - ì‹¤í–‰ ê°€ëŠ¥í•œ ì¸ì‚¬ì´íŠ¸ ì œê³µ

---

## í–¥í›„ í™•ì¥ ë°©í–¥

### ë‹¨ê¸° (1-2ê°œì›”)
- ê²½ìŸì‚¬ ë¸Œëœë“œ ì¶”ê°€ (Innisfree, Sulwhasoo ë“±)
- Google News API ì—°ë™ (PR/ë‰´ìŠ¤ ì´ë²¤íŠ¸)
- ë¦¬ë·° ê°ì„± ë¶„ì„ ê³ ë„í™”

### ì¤‘ê¸° (3-6ê°œì›”)
- ë­í‚¹ ë³€ë™ ì˜ˆì¸¡ ëª¨ë¸
- ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ (Slack, Email)
- Streamlit ëŒ€ì‹œë³´ë“œ

### ì¥ê¸° (6ê°œì›”+)
- ë‹¤ì¤‘ ë§ˆì¼“í”Œë ˆì´ìŠ¤ (Walmart, Target ë“±)
- A/B í…ŒìŠ¤íŠ¸ ë¶„ì„ (ê°€ê²© ë³€ë™ ì‹¤í—˜)
- ê²½ìŸ í¬ì§€ì…”ë‹ ìë™ ë¶„ì„

---

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… ìƒˆë¡œìš´ í”Œëœ ë¦¬ë·° ë° ìŠ¹ì¸
2. Phase 1 ì‹œì‘: DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ + ì´ë²¤íŠ¸ ê°ì§€
3. Phase 2: ì›ì¸ ë°ì´í„° ìˆ˜ì§‘ Flow êµ¬í˜„
4. Phase 3: LLM ì¸ì‚¬ì´íŠ¸ ìƒì„±
5. Phase 4: ë¦¬í¬íŠ¸ & ì•Œë¦¼
